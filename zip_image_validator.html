<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <title>Verificador de Imágenes en ZIP</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <style>
        body {
            background-color: #f0f0ff;
        }

        .tabla-scroll {
            max-height: 600px;
            overflow-y: auto;
        }

        .card {
            background-color: #ffffff;
        }

        h2 {
            color: #6a1a8c;
            font-weight: bold;
        }

        .form-label {
            color: #8a2be2;
        }

        .btn-primary,
        .btn-success {
            background-color: #8a2be2;
            border-color: #8a2be2;
            color: #fff;
        }

        .btn-primary:hover,
        .btn-success:hover {
            background-color: #6a1a8c;
            border-color: #6a1a8c;
        }

        /* Colores de la tabla de Bootstrap */
        .table-success {
            --bs-table-bg: #d1e7dd !important;
        }

        .table-warning {
            --bs-table-bg: #fff3cd !important;
        }

        .table-danger {
            --bs-table-bg: #f8d7da !important;
        }

        /* Ajuste de color de fuente para la tabla */
        .table-striped>tbody>tr.table-success:nth-of-type(odd)>*,
        .table-striped>tbody>tr.table-warning:nth-of-type(odd)>*,
        .table-striped>tbody>tr.table-danger:nth-of-type(odd)>* {
            background-color: var(--bs-table-striped-bg-factor, 0.95);
        }
    </style>
</head>

<body>

    <div class="container py-5">
        <h2 class="text-center mb-4">Verificador de Imágenes en Carpetas ZIP</h2>

        <div class="card shadow p-4 mb-4">
            <div class="mb-3">
                <label for="zipInput" class="form-label fw-bold">1. Cargar archivo ZIP con carpetas</label>
                <input type="file" id="zipInput" accept=".zip" class="form-control">
            </div>
            <div class="mb-3">
                <label for="numFotos" class="form-label fw-bold">2. Número de fotos que debe haber en cada
                    carpeta</label>
                <input type="number" id="numFotos" class="form-control" value="4" min="1">
            </div>
            <button class="btn btn-primary w-100" onclick="procesarZip()">3. Verificar Imágenes</button>
        </div>

        <div id="resultado" class="card shadow p-4 d-none">
            <h4>Resultados de la Verificación:</h4>
            <div class="tabla-scroll">
                <table class="table table-striped table-hover">
                    <thead>
                        <tr>
                            <th>Estatus</th>
                            <th>Nombre de la Carpeta</th>
                            <th>N° de Fotos</th>
                        </tr>
                    </thead>
                    <tbody id="listaResultados">
                    </tbody>
                </table>
            </div>
            <div class="text-center mt-4">
                <button class="btn btn-success" onclick="exportarExcel()">
                    <i class="bi bi-download"></i> Descargar Reporte en Excel
                </button>
            </div>
        </div>
    </div>

    <script>
        let resultadosFinales = [];

        async function procesarZip() {
            const zipInput = document.getElementById('zipInput');
            const file = zipInput.files[0];
            const numFotosDeseado = parseInt(document.getElementById('numFotos').value);
            const resultadosDiv = document.getElementById('resultado');
            const listaResultados = document.getElementById('listaResultados');

            listaResultados.innerHTML = "";
            resultadosDiv.classList.add('d-none');
            resultadosFinales = [];

            if (!file) {
                alert("Por favor, carga un archivo ZIP.");
                return;
            }

            try {
                const zip = await JSZip.loadAsync(file);
                const conteoImagenes = {};
                const nombresDeCarpetas = new Set();

                zip.forEach((relativePath, zipEntry) => {
                    if (zipEntry.dir) {
                        const nombreCarpeta = relativePath.split('/').filter(Boolean).pop();
                        if (nombreCarpeta) {
                            nombresDeCarpetas.add(nombreCarpeta);
                        }
                    } else {
                        const partesRuta = relativePath.split('/');
                        const nombreCarpeta = partesRuta[partesRuta.length - 2];
                        const nombreArchivo = partesRuta[partesRuta.length - 1].toLowerCase();

                        if (nombreCarpeta && (nombreArchivo.endsWith('.jpg') || nombreArchivo.endsWith('.jpeg') || nombreArchivo.endsWith('.png'))) {
                            conteoImagenes[nombreCarpeta] = (conteoImagenes[nombreCarpeta] || 0) + 1;
                        }
                    }
                });

                // Incluir carpetas sin imágenes en el conteo
                nombresDeCarpetas.forEach(nombre => {
                    if (!(nombre in conteoImagenes)) {
                        conteoImagenes[nombre] = 0;
                    }
                });

                for (const carpeta in conteoImagenes) {
                    const count = conteoImagenes[carpeta];
                    let estatus, color;

                    if (count === numFotosDeseado) {
                        estatus = "Correcto";
                        color = "table-success";
                    } else if (count < numFotosDeseado) {
                        estatus = "Faltan fotos";
                        color = "table-danger";
                    } else {
                        estatus = "Sobran fotos";
                        color = "table-warning";
                    }

                    // Agregar resultado a la tabla
                    const tr = document.createElement('tr');
                    tr.className = color;
                    tr.innerHTML = `
                        <td>${estatus}</td>
                        <td>${carpeta}</td>
                        <td>${count}</td>
                    `;
                    listaResultados.appendChild(tr);

                    // Guardar para exportar a Excel
                    resultadosFinales.push({
                        'Nombre de la Carpeta': carpeta,
                        'Número de Fotos': count,
                        'Estatus': estatus
                    });
                }

                resultadosDiv.classList.remove('d-none');

            } catch (error) {
                alert("Ocurrió un error al procesar el archivo ZIP. Asegúrate de que es un archivo válido.");
                console.error(error);
            }
        }

        function exportarExcel() {
            if (resultadosFinales.length === 0) {
                alert("No hay resultados para exportar. Por favor, realiza una verificación primero.");
                return;
            }

            const ws = XLSX.utils.json_to_sheet(resultadosFinales);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Resultados");

            // Descargar el archivo
            XLSX.writeFile(wb, "Reporte_Fotos_ZIP.xlsx");
        }
        // La ruta '../Inicio.html' asume que Menu_Principal.html está en una subcarpeta (ej. 'Herramientas').
        if (sessionStorage.getItem("isLoggedIn") !== "true") {
            window.location.replace('Inicio.html');
        }

        // Esta función se activará al hacer clic en "Cerrar sesión"
        function cerrarSesion() {
            sessionStorage.removeItem("isLoggedIn");
            window.location.replace('Inicio.html');
        }
    </script>
</body>

</html>